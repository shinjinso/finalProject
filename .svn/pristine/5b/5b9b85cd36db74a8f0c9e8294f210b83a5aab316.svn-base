<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<!DOCTYPE html>
<html>
<head>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<meta charset="UTF-8">
<title>Insert title here</title>
<style>
a:link {
	color: black;
	text-decoration: none;
}

a:visited {
	color: black;
	text-decoration: none;
}

a {
	text-decoration-line: none;
}
#contaner{
   width: 90%;
}

#resultFild{
   margin-top: 20px;
}
#wetreeJsContaner{
    display: none; 
    width: 100%; 
    height: 100%; 
    background-color: rgba(240, 240, 240, 0.9); 
     position: fixed;  
    z-index: 7000;  
    padding-left: 350px;	
    padding-top: 140px;
    
}
#wetreeJs{
   margin: 50px auto;
   width: 60%;
   height: 70%;
}
</style>
</head>
<body>
	<div>
		<h2>
			<font style="vertical-align: inherit;"><a href="/vct/main">내 휴가&nbsp;&nbsp;&nbsp;&nbsp;</a></font>
		</h2>
		<hr>
		<h4>
			<font style="vertical-align: inherit;"><a href="/vct/main">휴가&nbsp;&nbsp;</a></font>
			<font style="vertical-align: inherit;"><a href="/vct/Annual">&nbsp;&nbsp;&nbsp;연차&nbsp;&nbsp;</a></font>
			<font style="vertical-align: inherit;"><a href="/vct/bkApply">&nbsp;&nbsp;&nbsp;휴직/복직</a></font>
		</h4>
		<hr>
	</div>
	    <div class="card-body">
			<div style="vertical-align: inherit;">
	        <h2 class="card-title">휴직 신청</h2>
		        <div style="margin-left:10%;">
		            <button type="button" id = "cancel" class="btn mb-2 btn-outline-danger float-right"><font style="vertical-align: inherit;">취소</font></button>
		            <button type="button" id=insertSave class="btn mb-2 btn-outline-info float-right">저장 하기</button>
		        </div>
		        <div>
		        </div>
	     </div>
	</div>
		<div class="table">
			<table class="table table-bordered">
				<tr>
					<td>휴 직 명</td>
					<td>
						<div class="form-group col-md-4" style="margin-top:20px;">
		                    <select id="inputState5" class="form-control">
		                      <option disabled selected hidden>휴직 종류를 선택해주세요</font></option>
		                      <option>육아 휴직</option>
		                      <option>질병 휴직</option>
		                      <option>병역 휴직</option>
		                      <option>가족 돌봄 휴직</option>
		                    </select>
	               	 	 </div>
					</td>
					
                     
				</tr>	
				<tr>
					<td>성    명</td>
					<td><input type="text" id="name" class="form-control" readonly></td>
				</tr>
				<tr>
					<td>직    위</td>
					<td><input type="text" id="code" class="form-control" readonly></td>
				</tr>
				<tr>
		            <td>휴 직 시 작 일</td>
		            <td><input class="form-control" id="startDate" type="date" name="sDate"></td>
		        </tr>
		        <tr>
		            <td>휴 직 종 료 일</td>
		            <td><input class="form-control" id="endDate" type="date" name="eDate"></td>
		        </tr>
			</table>
            <div class="form-group mb-3" >
	            <div class="" style="width:100%; display:flex;">
	                <textarea class="form-control" id="example-textarea" rows="8" placeholder="휴직 사유를 입력해주세요"></textarea>
	            
               <div class="card-body" style="width: 100%; height:200px; background-color: white;">
<!-- 				    <form action="/main" class="dropzone bg-light rounded-lg dz-clickable myFileupload" id="tinydash-dropzone" style="height: 100%;"> -->
<!-- 				        <div class="dz-message needsclick"> -->
<!-- 				            <div class="circle circle-lg bg-primary"> -->
<!-- 				                <i class="fe fe-upload fe-24 text-white"></i> -->
<!-- 				            </div> -->
<!-- 				            <h5 class="text-muted mt-4"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">여기에 파일을 놓거나 클릭하여 업로드하세요.</font></font></h5> -->
<!-- 				        </div> -->
				    <input type="file" name="file" class="myFileupload" />
<!-- 				    </form> -->
<!-- 				    <input type="submit" value="파일 업로드" id="Fileupload" name="files"/> -->
                      <!-- Preview -->
                      <!-- <div class="dropzone-previews mt-3" id="file-previews"></div> -->
                      <!-- file preview template -->
                      <div class="d-none" id="uploadPreviewTemplate">
                        <div class="card mt-1 mb-0 shadow-none border">
                          <div class="p-2">
                            <div class="row align-items-center">
                              <div class="col-auto">
                                <img data-dz-thumbnail="" src="#" class="avatar-sm rounded bg-light" alt="">
                              </div>
                              <div class="col pl-0">
                                <a href="javascript:void(0);" class="text-muted font-weight-bold" data-dz-name=""></a>
                                <p class="mb-0" data-dz-size=""></p>
                              </div>
                              <div class="col-auto">
                                <!-- Button -->
                                <a href="" class="btn btn-link btn-lg text-muted" data-dz-remove="">
                                  <i class="dripicons-cross"></i>
                                </a>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    </div>
				</div>
	<div class="row">
    <div class="col-md-6">
        <div class="card-body">
            <!-- Button trigger modal -->
            <h2 class="card-title">
                <font style="vertical-align: inherit;">휴직 신청내역</font>
            </h2>
            <div id="tableContainer" style="display: flex;">
                <div style="flex: 1;">
                    <table class="table table-hover" id="vacationTable">
                        <thead>
                            <tr>
                                <th><font style="vertical-align: inherit;">휴 직 명</font></th>
                                <th><font style="vertical-align: inherit;">휴 직 시 작 일</font></th>
                                <th><font style="vertical-align: inherit;">휴 직 종 료 일</font></th>
                                <th><font style="vertical-align: inherit;">증 명 자 료 여 부</font></th>
                                <th><font style="vertical-align: inherit;">승 인 상 태</font></th>
                            </tr>
                        </thead>
                        <tbody>
                            <c:forEach var="BkApplyVO" items="${applyList}" varStatus="status">
                                <tr class="selectOne" data-toggle="modal" data-target="#verticalModal">
                                    <input type="hidden" name="bkNo" value="${BkApplyVO.bkNo}" />
                                    <td><font style="vertical-align: inherit;">
                                            <input type="hidden" name="bkNameSelect" />${BkApplyVO.bkName}
                                        </font></td>
                                    <td><font style="vertical-align: inherit;">${BkApplyVO.bkSdate}</font></td>
                                    <td><font style="vertical-align: inherit;">${BkApplyVO.bkEdate}</font></td>
                                    <td><span class="badge badge-pill badge-danger">
                                            <font style="vertical-align: inherit;">${BkApplyVO.bkCertYn}</font></span></td>
                                    <td><span class="badge badge-pill badge-warning">
                                            <font style="vertical-align: inherit;">${BkApplyVO.bkApstCode}</font></span></td>
                                </tr>
                                <input type="hidden" id="fileSetting" name="fileSetting" />${BkApplyVO.fileSetting}
                            </c:forEach>
                        </tbody>
                    </table>
                </div>
            </div>
	    </div>
    </div>
    <div class="col-md-6">
        <div class="card-body">
            <!-- Button trigger modal -->
            <font style="font-size:20px;">
                <button type="button" id="rsRequest" class="btn mb-2 btn-outline-success float-right"
                    data-toggle="modal" data-target="#verticalModal3"
                    style="float:right; width:150px; height:50px;">복직 신청하기</button>
            </font>
            <h2 class="card-title">
                <font style="vertical-align: inherit;">복직 신청내역</font>
            </h2>
            <div id="tableContainer" style="display: flex;">
                <div style="flex: 1;">
                    <table class="table table-hover" id="vacationTable">
                        <thead>
                            <tr>
                                <th><font style="vertical-align: inherit;">소 속</font></th>
                                <th><font style="vertical-align: inherit;">성 명</font></th>
                                <th><font style="vertical-align: inherit;">직 위</font></th>
                                <th><font style="vertical-align: inherit;">복 직 희 망 일</font></th>
                                <th><font style="vertical-align: inherit;">승 인 상 태</font></th>
                            </tr>
                        </thead>
                        <tbody>
                           <c:forEach var="rsReqst" items="${empList}" varStatus="status">
					    <tr class="selectOne2" data-toggle="modal" data-target="#verticalModal3">
					    	<input type="hidden" id="rsNo" name="rsNo" value="${rsReqst.rsNo }"/>
					        <td><font style="vertical-align: inherit;">${rsReqst.dnm}</font></td>
					        <td><font style="vertical-align: inherit;">${rsReqst.empNm}</font></td>
					        <td><font style="vertical-align: inherit;">${rsReqst.ptnCode}</font></td>
					        <td><font style="vertical-align: inherit;">${rsReqst.rsDate}</font></td>
					        <td id="" class="rsApstCode"><span class="badge badge-pill badge-warning">
					                <font style="vertical-align: inherit;">${rsReqst.rsApstCode}</font></span></td>
					    </tr>
					    <input type="hidden" id="dftNo" name="rsdftNo" />
					    <input type="hidden" id="fileSetting" name="rsfileSetting" />
					</c:forEach>
                        </tbody>
                    </table>
                </div>
            </div>
	    </div>
    </div> 
</div>
		<!-- 모달모달모달모달모달모달모달모달모달모달모달모달모달모달모달 -->
                      <!-- Modal -->
   <div class="modal fade" id="verticalModal" tabindex="-1" role="dialog" aria-labelledby="verticalModalTitle" style="display: none;" aria-hidden="true">
     <div class="modal-dialog modal-dialog-centered" role="document">
       <div class="modal-content" style="width:120%;">
         <div class="modal-header">
           <div class="table">
			<table class="table table-bordered">
				<tr>
					<td>휴 직 명</td>
					<td>
						<div class="form-group col-md-4" style="margin-top:20px;">
		                   <select id="bkNameSelect" class="form-control" style="width: 180px;">
						        <option selected hidden>휴직 종류 선택</option>
						        <option value="육아 휴직">육아 휴직</option>
						        <option value="질병 휴직">질병 휴직</option>
						        <option value="병역 휴직">병역 휴직</option>
						        <option value="가족 돌봄 휴직">가족 돌봄 휴직</option>
						    </select>
	               	 	 </div>
					</td>
				</tr>	
				<tr>
		            <td>휴 직 시 작 일</td>
		            <td><input class="form-control" id="startDate" type="date" name="sDate"></td>
		        </tr>
		        <tr>
		            <td>휴 직 종 료 일</td>
		            <td><input class="form-control" id="endDate" type="date" name="eDate"></td>
		        </tr>
			</table>
            <div class="form-group mb-3" >
	            <div style="width:320px; display:flex;">
	                <textarea class="form-control" id="bkRsn" rows="8" placeholder="휴직 사유를 입력해주세요"></textarea>
	            
               <div class="card-body" style="width: 20%; height:200px; background-color: white;">
				                <input type="file" name="file" class="myFileupload"/><br><br>
					                <div style="display: flex; align-items: center;">
						                <div id="orfiName">
						                </div>
							                <button type="button" class="close"  aria-label="Close">
															<span aria-hidden="true">×</span>
										</button>
				                	</div>
<!-- 				    <form action="/fileUpload" class="dropzone bg-light rounded-lg dz-clickable" id="tinydash-dropzone" style="height: 100%;"> -->
<!-- 				        <div class="dz-message needsclick"> -->
<!-- 				            <div class="circle circle-lg bg-primary"> -->
<!-- 				                <i class="fe fe-upload fe-24 text-white"></i> -->
<!-- 				            </div> -->
<!-- 				            <h5 class="text-muted mt-4"><font style="vertical-align: inherit;">여기에 파일을 업로드하세요.</font></h5> -->
<!-- 				        </div> -->
<!-- 				    </form> -->
                      <div class="d-none" id="uploadPreviewTemplate">
                        <div class="card mt-1 mb-0 shadow-none border">
                          <div class="p-2">
                            <div class="row align-items-center">
                              <div class="col-auto">
                                <img data-dz-thumbnail="" src="#" class="avatar-sm rounded bg-light" alt="">
                              </div>
                              <div class="col pl-0">
                                <a href="javascript:void(0);" class="text-muted font-weight-bold" data-dz-name=""></a>
                                <p class="mb-0" data-dz-size=""></p>
                              </div>
                              <div class="col-auto">
                                <!-- Button -->
                                <a href="" class="btn btn-link btn-lg text-muted" data-dz-remove="">
                                  <i class="dripicons-cross"></i>
                                </a>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    </div>
				</div>
                 </div>  
						<div class="col-4 float-right">
	                       	<p class="h4">승인참조</p>
	                    	   <hr/>
	                     <div id="resultApprovePlus">
	                        <p class="PlusBtnContaner"><label class="h5" for="chamjo">1단계</label> <input type="button" class="btn mb-2 btn-outline-dark approvePlusBtn" value="+" style="float: right;"></p>
	                     </div>
	               		    <button id="approveLevelBtn" type="button" class="btn mb-2 btn-secondary btn-block">+ 단계 추가하기</button>
	               
	                    </div>
            		</div>
                      	 <div class="modal-footer">
							<button type="button" id="delete" class="btn mb-2 btn-outline-danger" data-dismiss="modal" >취소하기</button>
							<button type="button" id="update" name="upDate" class="btn mb-2 btn-outline-warning">수정하기</button>
							<button type="button" id="insert" name="insert" class="btn mb-2 btn-outline-primary">결재요청</button>
						</div>
           		 </div>
              </div>
           </div>          
                      
                      
   <div class="modal fade" id="verticalModal3" tabindex="-1" role="dialog" aria-labelledby="verticalModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rsRequest">복직 신청</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-md-6">
                            <!-- 좌측 내용 -->
                            <div class="card" style="margin-bottom: 20px;">
                                <div class="card-body" style="text-align:center;">
                                    <h5 class="card-title">1. 인적 사항</h5>
                                    <table class="table table-bordered table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th>소속</th>
                                                <th>사번</th>
                                                <th>성명</th>
                                                <th>직위</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td id="dnm"></td>
                                                <td id="empNo1" class="empNo1"></td>
                                                <td id="empNm1"></td>
                                                <td id="ptnCode"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">2. 복직 사유</h5>
                                    <textarea class="form-control" id="rsResn" rows="10" placeholder="복직 사유를 입력해주세요"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <!-- 우측 내용 -->
                            <div class="card" style="margin-bottom: 20px;">
                                <div class="card-body">
                                    <h5 class="card-title">3. 복직 희망 날짜</h5>
                                    <div style="display: flex;">
                                        <div style="width: 220px; height:80px;">
                                            <input class="form-control" id="hopedate" type="date" name="rsDate" value="date">
                                        </div>
                                        <div class="card shadow mb-4" style="width: 210px; height:37px; margin-left:1%;">
                                            <div class="card-body text-center">
                                                2
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card" style="margin-bottom: 20px; height: 300px;">
                                <div class="col-4 float-right"  style="width:2000px;">
				                       <p class="h4">승인참조</p>
				                       <hr/>
				                     <div id="resultApprovePlus1">
				                        <p class="PlusBtnContaner"><label class="h5" for="chamjo">1단계</label> <input type="button" class="btn mb-2 btn-outline-dark approvePlusBtn" value="+" style="float: right;"></p>
				                     </div>
				                     <button id="approveLevelBtn1" type="button" class="btn mb-2 btn-secondary btn-block">+ 단계 추가하기</button>
				               
				                    </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <!-- 모달 푸터 내용 -->
                <button type="button" id="delete" class="btn mb-2 btn-outline-danger" data-dismiss="modal">취소하기</button>
                <button type="button" id="modalUpdate" name="upDate" class="btn mb-2 btn-outline-warning">수정하기</button>
                <button type="button" id="RsSave" name="save" class="btn mb-2 btn-outline-info">추가하기</button>
                <button type="button" id="Approval2" name="insert" class="btn mb-2 btn-outline-primary">결재요청</button>
            </div>
        </div>
    </div>
</div>
                    
	<!-- script 시작 script 시작 script 시작 script 시작 script 시작 script 시작 script 시작-->
	<script>
    
    const rsDate = $("input[name=rsDate]");
    const rsResn = $("#rsResn");
    const rsApstCode = $(".rsApstCode");
    const dftNo = $("input[name=rsdftNo]");
    const fileSetting = $("input[name=rsfileSetting]");
    const empNo = $("#empNo1");
    const empNm = $("#empNm1");
    const ptnCode = $("#ptnCode");
    const dnm = $("#dnm");
    const rsNo = $('input[name=rsNo]');
   
	//결재선 올리기
   $("#Approval2").on("click", function () {
    console.log("rsNo입니다.:", rsNo);
    var today = new Date();
    var year = today.getFullYear();
    var month = ('0' + (today.getMonth() + 1)).slice(-2);
    var day = ('0' + today.getDate()).slice(-2);
    var dateString = year + '-' + month + '-' + day;
    console.log(dateString);

    let empNo = $(".empNo1");

    RsReqstVO = {
        "rsDate": rsDate.val(),
        "rsResn": rsResn.val(),
        "rsApstCode": rsApstCode.val(),
        "dftNo": dftNo.val(),
        "fileSetting": fileSetting.val(),
        "empNo": empNo.text(),
        "empNm": empNm.text(),
        "ptnCode": ptnCode.text(),
        "dnm": dnm.text(),
        "rsNo": rsNo.val()
        
    };
    const dftNoValue = dftNo.val();
    console.log("dftNo:제발", dftNoValue);	
    console.log("#######RsReqstVO#######", RsReqstVO);

    let checkEmpNo = $(".checkEmpNo");
    let apboxData = []; // ApboxList
    for (let i = 0; i < checkEmpNo.length; i++) {
        let serialNumber = i + 1;
        let empNo = checkEmpNo[i].value;

        let apboxVO = {
            "serialNumber": serialNumber,
            "empNo": empNo
//             "dftNo": dftNo
        };
        apboxData.push(apboxVO);
    console.log("@@@여기는 apboxVO@@@", apboxVO);
    }

    let totalData = [
        RsReqstVO,
        apboxData
    ];
    console.log("###여기는 totalData###", totalData);

    $.ajax({
        type: "post",
        url: "/vct/RsmultiInsert",
        contentType: "application/json; charset:utf-8",
        data: JSON.stringify(totalData),
        dataType: "json",
        beforeSend: function (xhr) {
            xhr.setRequestHeader("${_csrf.headerName}", "${_csrf.token}");
        },
        success: function () {
            Swal.fire("모두 성공");
        },
        error: function (xhr, status, error) {
            console.error("AJAX 오류:", error);
        }
    });
})
    	
    	
    	
    //내역별 update
	$("#modalUpdate").on("click",function(){
		 const rsDate = $("input[name=rsDate]");
		    const rsResn = $("#rsResn");
		    const rsApstCode = $("#rsApstCode");
		    const dftNo = $("#rsdftNo");
		    const fileSetting = $("input[name=rsfileSetting]");
		    const empNo = $("#empNo1");
		    const empNm = $("#empNm1");
		    const ptnCode = $("#ptnCode");
		    const dnm = $("#dnm");
		    const rsNo = $('input[name=rsNo]');
		
		
		let data={
				"rsDate" : rsDate.val(),
				"rsResn" : rsResn.val(),
				"rsNo" : rsNo.val()
		}
		console.log("이건 update data:",data);
		$.ajax({
			type:"post",
			url:"/vct/rsModal",
			data: JSON.stringify(data),
			contentType:"application/json;charset=utf-8",
			dataType : "text",
			beforeSend:function(xhr){
				xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
			},
			success: function (result) {
				Swal.fire("수정이 완료되었습니다.");
	           
	        },
	        error: function(xhr, status, error) {
                console.error("AJAX 오류:", error);             
            }
		})
		
	});
	
	//모달속 내역별 조회
	
	$(".selectOne2").on("click", function () {
	    console.log("이건 this", this);
	    let rsNo = $(this).find('input[name=rsNo]').val();
	    
	    $.ajax({
	        type: "get",
	        url: "/vct/rsModal/"+rsNo,
	        success: function (result) {
	            console.log("이건 복직 result값", result);

	            rsDate.val(result.rsDate);
	            rsResn.val(result.rsResn);
	            rsApstCode.val(result.rsApstCode);
	            dftNo.val(result.dftNo);
	            fileSetting.val(result.fileSetting);
	            empNo.text(result.empNo);
	            empNm.text(result.empNm);
	            ptnCode.text(result.ptnCode);
	            dnm.text(result.dnm);
	            
	            console.log("rsDate.val(result.rsDate)",rsDate.val(result.rsDate));
	        },
	        error: function (xhr, status, error) {
	            console.error("AJAX 오류:", error);
	        }
	    });
	});
	
	//복직 신청하기
	$("#RsSave").on("click",function(){
		//RS_APST_CODE, DFT_NO
		const rsDate = $("input[name=rsDate]").val();
		const rsResn = $("#rsResn").val();
		const rsApstCode = $("#rsApstCode").val();
		const dftNo = $("#rsdftNo").val();
		const fileSetting = $("input[name=rsfileSetting]").val();
		let data={
				"rsDate": rsDate,
				"rsResn": rsResn,
				"rsApstCode": rsApstCode,
				"dftNo": dftNo,
				"fileSetting": fileSetting
		}
		
		console.log("이것은 복직신청 Data",data);
		$.ajax({
			type:"post",
			url:"/vct/insertReqst",
			contentType:"application/json;charset=utf-8",
			data: JSON.stringify(data),
			dataType:"json",
			beforeSend: function (xhr) {
	            xhr.setRequestHeader("${_csrf.headerName}", "${_csrf.token}");
	        },
	        success: function (result) {
	        	swal.fire("추가 성공");
	        	
	        },
	        error: function (xhr, status, error) {
	            console.error("AJAX 오류:", error);
	        }	
	        
		})
	});
	
	
	//복직신청 내역 조회
    $("#rsRequest").on("click",function(){
    	
	var empNo = sessionStorage.getItem("empNo");
		console.log("empNo입니다.이건 ",empNo);
    $.ajax({
	        type: "get",
	        url: "/vct/selectEmpInfo/" + empNo,
	        contentType: "application/json;charset=utf-8",
	        dataType: "json", 
	        success: function (result) {
	            console.log("성공헀냐?:", result);
	            	
	            // 데이터를 화면에 출력
	            $("#empNo1").text(result.empNo);
	            $("#empNm1").text(result.empNm);
	            $("#ptnCode").text(result.ptnCode);
	            $("#dnm").text(result.dnm);
	            	console.log("이건dnm",dnm);
	            	
	        },
	        error: function (xhr, status, error) {
	            console.error("AJAX 오류:", error);
	        }
	    });
   	});
	
	
	
	//여기가 휴직신청내역 모달 업데이트 하기직전 코드 다시 해야됨 보류
	$("#update").on("click", function () {
	    const bkName = $("#bkNameSelect").val();
	    const bkSdate = $("#startDate").val();
	    const bkEdate = $("#endDate").val();
	    const bkRsn = $("#bkRsn").val();
	    const bkApstCode = 'C0104';
	    const bkCertYn = $("input[name=file]").val() != "" ? "B0103" : "B0104";
	    
	    const orfiName = $("#orfiName").text();
	    const $myFile = $("input[name=file]");
        
	    var formData = new FormData();
        var check = formData.append("file", $myFile[0].files[0]);
        
	    console.log("이건 orfiName:",orfiName);
	    console.log("이건 check:",check);
	    console.log("이건 $myFile:",$myFile);
	    
	    let bkApplyVO = {
	        "bkName": bkName,
	        "bkSdate": bkSdate,
	        "bkEdate": bkEdate,
	        "bkRsn": bkRsn,
	        "bkApstCode": bkApstCode,
	        "bkCertYn": bkCertYn
	    }

	    console.log("이 데이터는 update할 Data", bkApplyVO);
	    
// 	if(check != null && check !=""){ //파일이 있을때
	    $.ajax({
	        type: "put",
	        url: "/vct/bkUpdate",
	        data: JSON.stringify(bkApplyVO),
	        contentType: "application/json;charset=utf-8",
	        dataType: "text",
	        beforeSend: function (xhr) {
	            xhr.setRequestHeader("${_csrf.headerName}", "${_csrf.token}");
	        },
	        success: function (rslt) {
	            Swal.fire("수정이 완료되었습니다.");

	            // 파일 업로드 업데이트

// 	            console.log("formData", formData);
// 	            console.log("check", check);
// 	            $.ajax({
// 	                url: "/vct/fileUpdate",
// 	                type: "put",
// 	                data: formData,
// 	                contentType: false,
// 	                processData: false,
// 	                cache: false,
// 	                dataType: "text",
// 	                beforeSend: function (xhr) {
// 	                    xhr.setRequestHeader("${_csrf.headerName}", "${_csrf.token}");
// 	                },
// 	                success: function (result) {
// 	                    console.log("이건 파일 업로드 업데이트");
// 	                },
// 	                error: function (xhr, status, error) {
// 	                    console.error("AJAX 오류:", error);
// 	                }
// 	            });
	        },
	        error: function (xhr, status, error) {
	            console.error("AJAX 오류:", error);
	        }
	    });
});//이거 지워야됨
// 	}
// 		if(check == null && check ==""){ //파일이 없을때 
			
// 		    let bkApplyVO = {
// 			        "bkName": bkName,
// 			        "bkSdate": bkSdate,
// 			        "bkEdate": bkEdate,
// 			        "bkRsn": bkRsn,
// 			        "bkApstCode": bkApstCode,
// 			        "bkCertYn": bkCertYn
// 			    }
// 		    console.log("이 데이터는 update할 Data", bkApplyVO);
		    
// 		    $.ajax({
// 		        type: "put",
// 		        url: "/vct/bkUpdate",
// 		        data: JSON.stringify(bkApplyVO),
// 		        contentType: "application/json;charset=utf-8",
// 		        dataType: "text",
// 		        beforeSend: function (xhr) {
// 		            xhr.setRequestHeader("${_csrf.headerName}", "${_csrf.token}");
// 		        },
// 		        success: function (rslt) {
// 		        	console.log("이건 rslt값:",rslt);
// 		            Swal.fire("수정이 완료되었습니다.");
// 		        },
// 		        error: function (xhr, status, error) {
// 		            console.error("AJAX 오류:", error);
// 		        }
// 		    })
// 		}
// 	});
	
	
	
	$(".selectOne").on("click", function () {
        let bkCertYn = $("input[name=file]").val() != "" ? "B0103" : "B0104"; 
		let bkNo = $(this).find("input[name=bkNo]").val();
	    let $this = $(this);
	    console.log("this", this);
		
		const $myFile = $("input[name=file]");
        
        var formData = new FormData();
        var check = formData.append("file", $myFile[0].files[0]);
        console.log("formData", formData);
        console.log("check", check);
	    
	    $.ajax({
	        type: "get",
	        url: "/vct/bkSelectOne/" + bkNo,
	        success: function (rslt) {
	            console.log("이건 result인데", rslt);

	            $("#bkNameSelect").val(rslt.result.bkName);
	            $("input[name=sDate]").val(rslt.result.bkSdate);
	            $("input[name=eDate]").val(rslt.result.bkEdate);
	            $("#bkRsn").val(rslt.result.bkRsn);
	            $("#orfiName").text(rslt.result1.orfiName);
	         	$("input[name=FileSetting]").val(bkCertYn);
	            console.log("Setting fileSetting value:", rslt.result1.fileSetting);
				
	        },

	        error: function (xhr, status, error) {
	            console.error("AJAX 오류:", error);
	        }
	    });
	});
	//신청 내역 조회
	window.onload= function empList() {
    
	var empNo = sessionStorage.getItem("empNo");
    $.ajax({
	        type: "get",
	        url: "/vct/bkApply/" + empNo,
	        dataType: "json", 
	        success: function (result) {
	            console.log("성공:", result);
	            	
	            // 데이터를 화면에 출력
	            $("#name").val(result.empNm);
	            $("#code").val(result.ptnCode);
	        },
	        error: function (xhr, status, error) {
	            console.error("AJAX 오류:", error);
	        }
	    });
	}
	
	$("#insertSave").on("click", function() {
		const $myFile = $("input[name=file]");
        
        var formData = new FormData();
        var check = formData.append("file", $myFile[0].files[0]);
        console.log("formData", formData);
        
        var check = $(".myFileupload").val();
        
        console.log("check::", check);
        
        if(check != null && check != "") {
        	// 파일 업로드
            $.ajax({
                url: "/vct/fileInsert",
                type: "post",
                data: formData,
                contentType: false,
                processData: false,
                cache: false,
                dataType: "text",
                beforeSend: function(xhr) {
                    xhr.setRequestHeader("${_csrf.headerName}", "${_csrf.token}");
                },
                success: function(result) {
                    console.log("Insert된 파일 번호:",result);
                    let bkCertYn = $("input[name=file]").val() != "" ? "B0103" : "B0104"; 

                    let data = {
                        bkName: $("#inputState5").val(),
                        bkSdate: $("#startDate").val(),
                        bkEdate: $("#endDate").val(),
                        bkRsn: $("#example-textarea").val(),
                        bkApstCode: 'C0104',
                        fileSetting: bkCertYn == "B0103" ? "vacation" : null, 
                        bkCertYn: bkCertYn,
                        dftNo: $("input[name=dftNo]").val(),
                        fileSn: result,
                       
                    };
					
                    console.log("data-->", data);

                    $.ajax({
                        type: "post",
                        url: "/vct/bkApply",
                        contentType: "application/json;charset=UTF-8",
                        data: JSON.stringify(data),
                        beforeSend: function(xhr) {
                            xhr.setRequestHeader("${_csrf.headerName}", "${_csrf.token}");
                        },
                        success: function(response) {
                            console.log(response);
                            Swal.fire("모든 내용이 잘 저장되었습니다.");	
                            
                        },
                        error: function(xhr, status, error) {
                            console.error("AJAX 오류:", error);
                            // TODO: AJAX 요청 실패 시 실행할 코드 작성
                            alert("AJAX 요청에 실패했습니다.");
                        }
                    });
                    
                },
                error: function(xhr, status, error) {
                	 Swal.fire("파일 미제출된 상태로 저장되었습니다..", error);
                }
            });
		}
        
        if(check == null || check == "") {
       		
       		let bkCertYn = $("input[name=file]").val() != "" ? "B0103" : "B0104"; 

       	    let data = {
       	        bkName: $("#inputState5").val(),
       	        bkSdate: $("#startDate").val(),
       	        bkEdate: $("#endDate").val(),
       	        bkRsn: $("#example-textarea").val(),
       	        bkApstCode: 'C0104',
       	        fileSetting: bkCertYn == "B0103" ? "vacation" : null, 
       	        bkCertYn: bkCertYn,
       	        dftNo: $("input[name=dftNo]").val(),
       	    };

       	    console.log("data-->", data);

       	    $.ajax({
       	        type: "post",
       	        url: "/vct/bkApply",
       	        contentType: "application/json;charset=UTF-8",
       	        data: JSON.stringify(data),
       	        beforeSend: function(xhr) {
       	            xhr.setRequestHeader("${_csrf.headerName}", "${_csrf.token}");
       	        },
       	        success: function(response) {
       	            console.log(response);
       	            Swal.fire("모든 내용이 잘 저장되었습니다.");	
       	            
       	        },
       	        error: function(xhr, status, error) {
       	            console.error("AJAX 오류:", error);
       	            // TODO: AJAX 요청 실패 시 실행할 코드 작성
       	            alert("AJAX 요청에 실패했습니다.");
       	        }
       	    });
       		
       	}
    });
	
   
   	
	
                
     //처음 저장할땐 insert, 다시 저장할땐 update

	
	
	
	//휴가창
   //승인참조 사람(단계 추가하기) 추가
   $("#approveLevelBtn").on("click",function(){
      var resultApprovePlus = document.getElementById('resultApprovePlus');
      var lastChild = resultApprovePlus.lastElementChild;
      var labelText = lastChild.querySelector('label').textContent;

      let result = "";
      switch(labelText){
         case "1단계" : 
            result = `<p class="PlusBtnContaner"><label class="h5" for="chamjo">2단계</label> <input type="button" class="btn mb-2 btn-outline-dark approvePlusBtn" value="+" style="float: right;"></p>`;
            break;
         case "2단계" : 
            result = `<p class="PlusBtnContaner"><label class="h5" for="chamjo">3단계</label> <input type="button" class="btn mb-2 btn-outline-dark approvePlusBtn" value="+" style="float: right;"></p>`
            break;
         case "3단계" :
            Swal.fire({
            icon: 'error',
            title: '잠깐!!',
            text: '참조대상은 3단계까지만 추가 가능해요!',
            })
            return; 
      }
      $("#resultApprovePlus").append(result);
   });
   $("#approveLevelBtn1").on("click",function(){
      var resultApprovePlus = document.getElementById('resultApprovePlus1');
      var lastChild = resultApprovePlus.lastElementChild;
      var labelText = lastChild.querySelector('label').textContent;

      let result = "";
      switch(labelText){
         case "1단계" : 
            result = `<p class="PlusBtnContaner"><label class="h5" for="chamjo">2단계</label> <input type="button" class="btn mb-2 btn-outline-dark approvePlusBtn" value="+" style="float: right;"></p>`;
            break;
         case "2단계" : 
            result = `<p class="PlusBtnContaner"><label class="h5" for="chamjo">3단계</label> <input type="button" class="btn mb-2 btn-outline-dark approvePlusBtn" value="+" style="float: right;"></p>`
            break;
         case "3단계" :
            Swal.fire({
            icon: 'error',
            title: '잠깐!!',
            text: '참조대상은 3단계까지만 추가 가능해요!',
            })
            return; 
      }
      $("#resultApprovePlus1").append(result);
   });
   
   
   //단계별 승인 참조대상 선택시 모달열기
   let mymodal = $("#wetreeJsContaner")
   $(document).on("click",".approvePlusBtn",function(){
       mymodal.css("display", "block");
       getJson(this);
   });
   
   //모달 닫기
   $("#myModalClose").on("click",function(){
      mymodal.css("display","none");
   })
   

   
   
   //jstree결과값 받기
   function getJson(thisBtn) {
   $.ajax({
           type:'get',
           url:'/approval/organizationChart',
           dataType:'json',
           success: function(data) {
            console.log("체킁 : ",data);
              let listOne = data.one;
              let listTwo = data.two;
              
               var company = new Array();
               // 데이터 받아옴
               $.each(listOne, function(idx, item){
                  if(item.uprDcode==0){
                     item.uprDcode = "#";
                  }
               company.push({id:item.dcode+"", parent:item.uprDcode+"", text:item.dnm});
               });
               $.each(listTwo, function(idx, item){
                  let temp = item.deptName;
                  if(temp==null){
                     
                  }else{
                  company.push({"id":item.uprDcode+""+idx, "parent":item.dcode+"", "text":item.deptName, "icon":"/resources/images/user2.png", "info":item.uprDcode+"" });
                  }
               });
                 console.log("최종",company);
            // 트리 생성
               $('#sujiTree').jstree({
                   core: {
                      data: company    //데이터 연결
                       },
                       types: {
                              'default': {
                                   'icon': 'jstree-folder'
                               }
                       },
                       plugins: ['wholerow', 'types','search','dnd','contextmenu']
                })
                .bind('loaded.jstree', function(event, data){
                       //트리 로딩 롼료 이벤트
                })
                .bind('select_node.jstree', function(event, data){
                   console.log("선택한노드:", data.node);
                   if(data.node.original.info != null){
                   $.ajax({
                      url : "/approval/selectEmp?keyword=" + data.node.original.info,
                      dataType : "json",
                      type : "get",
                      success : function(result){
                         let htmlCode = "";
                         console.log("result",result);
                        
                        htmlCode += `<talbe border="1" style="float:right;">
                                  <tr>
                                 	 <td><input type="hidden"  class = "checkEmpNo" value="\${result.empNo}"></td>
                                     <td><button type="button" class="badge badge-pill badge-info">\${result.empNm}</button></td>
                                     <td><span class="badge badge-pill badge-success"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\${result.dtCodeNm}</font></font></span></td>
                                  </tr>            
                        `;

                        let myparent = $(thisBtn).parent(); //내가 선택한 버튼의 부모요소 가져오기
                        let mychildrun = myparent.children(".approvePlusBtn")[0]; //자식요소중 삭제할 버튼 찾기
                        
                        myparent.remove(mychildrun); //삭제
                        mychildrun.style.display = "none";//버튼 없애기
                        
                        myparent.append(htmlCode);//추가


                        $('#sujiTree').jstree("destroy");//트리 초기화
                        $("#myModalClose").click();//모달 닫기버튼

                      }
                      })
                   };
                });
           },
           error:function (data) {
               alert("에러");
           }
      });
   }   




//jsTree 열고/닫기
let openTemp = false;
$("#open").on("click",function(){
   if(openTemp == false){
      $("#sujiTree").jstree("open_all");
   }else{
      $("#sujiTree").jstree("close_all");	
   }
   openTemp = !openTemp;
})
	</script>
</body>
</html>



